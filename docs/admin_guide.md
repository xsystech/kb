# Подробная инструкция по установке XRM Director v1.0 на Red OS 8.0


- [Общая информация](#-общая-информация)
- [Быстрый старт](#-быстрый-старт)
  - [CLI Режим (Командная строка)](#-cli-режим-командная-строка)
  - [Интерактивный режим (Меню)](#️-интерактивный-режим-меню)
- [Системные требования](#-системные-требования)
- [Подробное описание меню](#-подробное-описание-меню)
- [Компоненты системы](#-компоненты-системы)
- [Журналирование и мониторинг](#-журналирование-и-мониторинг)
- [Устранение проблем](#-устранение-проблем)

---

## Общая информация

**XRM Director** - это система анализа журналов используя большие языковые модели.

**Поддерживаемая ОС:** Red OS 8.0  
**Версия:** 1.0  
**Тип установки:** Docker-контейнеры  
**Архитектура:** x86_64  

---

## Быстрый старт

### Подготовка системы
```bash
# Скачайте скрипт установки
wget -O xrmd_install.sh https://files.x-rm.ru/xrm_director/xrmd_install.sh

# Сделайте скрипт исполняемым
chmod +x xrmd_install.sh
```

### CLI Режим (Командная строка)


#### Команды справки (без sudo):
```bash
# Показать справку
./xrmd_install.sh --help

# Показать версию скрипта
./xrmd_install.sh --version
```

#### Автоматическая установка (требует sudo):
```bash
# Облегченная версия с CPU (рекомендуется для большинства случаев)
sudo ./xrmd_install.sh install slim cpu

# Полная версия с CPU (больше возможностей, больше ресурсов)
sudo ./xrmd_install.sh install full cpu

# Облегченная версия с GPU (требуется NVIDIA GPU)
sudo ./xrmd_install.sh install slim gpu

# Полная версия с GPU (максимальная производительность)
sudo ./xrmd_install.sh install full gpu
```

#### Синтаксис CLI команд:
```
sudo ./xrmd_install.sh install <VERSION> <PROCESSOR>

VERSION:
  slim    - Облегченная версия (~2.62 GB, без встроенных моделей)
  full    - Полная версия (~7.12 GB, со встроенными моделями)

PROCESSOR:
  cpu     - Использовать CPU для обработки (универсальный)
  gpu     - Использовать GPU для обработки (требует NVIDIA GPU)
```

### Интерактивный режим (Меню)

Классический режим с пошаговым меню для интерактивной установки:

```bash
# Запустите скрипт с правами администратора
sudo ./xrmd_install.sh
```

---

## Системные требования

### Минимальные требования:
- **ОС:** Red OS 8.0
- **Процессор:** минимум 4 ядра CPU
- **Оперативная память:** минимум 16 GB RAM
- **Свободное место на диске:** минимум 50 GB
- **Права:** root/sudo доступ
- **Системный параметр:** vm.max_map_count ≥ 262144

### Дополнительные требования для GPU версии:
- **GPU:** NVIDIA с поддержкой CUDA
- **NVIDIA Driver:** версия 470+ 
- **NVIDIA Container Toolkit:** установлен

### Требования к ПО:
- **Docker:** минимум версия 24.0.0
- **Docker Compose:** минимум версия v2.26.1
- **Python**: версия >3.10 - <3.13, рекомендуемая 3.11

---

## Подробное описание меню

### Главное меню (Интерактивный режим)

После запуска скрипта `sudo ./xrmd_install.sh` вы увидите главное меню:

```
==========================================
          XRM Director версия 1.0         
==========================================

Меню:

1. Системные требования
2. Информация об установленных Docker / Docker Compose  
3. Установить Docker / Docker Compose (RedOS)
4. Установить XRM Director
5. Перезапустить XRM Director
6. Удалить XRM Director
7. Резервное копирование / Восстановление
8. Выйти
```

### Детальное описание пунктов меню:

- [1️⃣ Системные требования](#1️⃣-системные-требования)
- [2️⃣ Информация о Docker](#2️⃣-информация-об-установленных-docker--docker-compose)
- [3️⃣ Установить Docker](#3️⃣-установить-docker--docker-compose-redos)
- [4️⃣ Установить XRM Director](#4️⃣-установить-xrm-director)
- [5️⃣ Перезапустить XRM Director](#5️⃣-перезапустить-xrm-director)
- [6️⃣ Удалить XRM Director](#6️⃣-удалить-xrm-director)
- [7️⃣ Резервное копирование](#7️⃣-резервное-копирование--восстановление)
- [8️⃣ Выйти](#8️⃣-выйти)

---

### 1️⃣ Системные требования

**Назначение:** Проверка соответствия системы минимальным требованиям

**Что проверяется:**
- ✅ **Количество ядер процессора** (минимум 4)
- ✅ **Объем оперативной памяти** (минимум 16 GB)
- ✅ **Свободное место на диске** (минимум 50 GB)
- ✅ **Версия Docker** (минимум 24.0.0)
- ✅ **Версия Docker Compose** (минимум v2.26.1)
- ✅ **Версия Python** (>3.10 - <3.13)
  
---

### 2️⃣ Информация об установленных Docker / Docker Compose

**Назначение:** Проверка установленных версий Docker и Docker Compose

**Что отображается:**
- **Версия Docker** (минимум требуется: 24.0.0)
- **Версия Docker Compose** (минимум требуется: v2.26.1)
- **Количество образов и контейнеров** и их статус
- **Информация о системе Docker** (версия сервера, ОС)

---

### 3️⃣ Установить Docker / Docker Compose (RedOS)

**Назначение:** Автоматическая установка Docker и Docker Compose на Red OS

**Процесс установки включает:**

#### 3.1 Установка Docker и Docker Compose
- Установка пакетов `docker-ce`, `docker-ce-cli`, `docker-compose`
- Запуск и активация службы Docker
- Добавление пользователя в группу `docker`

#### 3.2 Проверка установки
- ✅ Проверка статуса службы Docker
- ✅ Вывод информации о Docker
- ✅ Проверка работоспособности

**Что делать после установки:**

Перезагрузите систему или перелогиньтесь для применения изменений группы, или выйдите и войдите снова

```bash
sudo reboot
```

---

### 4️⃣ Установить XRM Director

**Назначение:** Полная установка системы XRM Director

**Доступные способы установки:**

#### Способ 1: CLI режим (Автоматический)
```bash
# Облегченная версия с CPU
sudo ./xrmd_install.sh install slim cpu

# Полная версия с GPU
sudo ./xrmd_install.sh install full gpu
```

**Преимущества CLI режима:**
- **Быстрая установка** - без интерактивного выбора
- **Валидация** - автоматическая проверка параметров
- **Логирование** - все действия в `/var/log/xrmd_install.log`

#### Способ 2: Интерактивный режим (Пошаговый)
```bash
sudo ./xrmd_install.sh
# Выберите пункт 4 в меню
```

---

**Этапы установки (общие для обоих режимов):**

#### 4.1 Предварительные проверки
- ✅ Проверка прав root
- ✅ Проверка системных требований  
- ✅ Проверка установки Docker
- ✅ Проверка существующих установок

#### 4.2 Создание структуры директорий
```
/opt/xrm-director/
├── docker/                    # Docker конфигурация
│   ├── docker-compose.yml     # Основной compose файл (CPU)
│   ├── docker-compose-gpu.yml # GPU версия
│   └── .env                   # Переменные окружения
├── backups/                   # Резервные копии
│   ├── initial/               # Системные бэкапы
│   └── user/                  # Пользовательские бэкапы
└── utils
    └── xrmd_agent_manager.py  # Менеджер по работе с агентами
```

#### 4.3 Выбор конфигурации

**1. Выбор редакции:**
- **Slim** - облегченная версия (~2.62 GB, без встроенных моделей)
- **Full** - полная версия (~7.12 GB, со встроенными моделями)

**2. Выбор режима работы:**
- **CPU** - использовать процессор для обработки задач
- **GPU** - использовать графический процессор (требуется NVIDIA, NVIDIA Container Toolkit)

#### 4.4 Скачивание и настройка
- Загрузка Docker конфигурации с `https://files.x-rm.ru/xrm_director/docker/docker.tar.gz`
- Загрузка начального бэкапа с `https://files.x-rm.ru/xrm_director/backup/initial_backup.tar.gz`
- Настройка переменных окружения в `.env`
- Настройка системного параметра `vm.max_map_count=262144`

#### 4.5 Запуск контейнеров
- Запуск RAGFlow контейнеров
- Установка и запуск Ollama с моделями:
  - **llama3.1:8b** (основная языковая модель)
  - **snowflake-arctic-embed:335m** (модель для embeddings)
- Проверка готовности сервисов
- Автоматическое восстановление начального бэкапа (если включено)

#### 4.6 Используемые порты
- **80** - HTTP доступ к веб-интерфейсу RAGFlow
- **443** - HTTPS доступ (если настроен)
- **9380** - Внутренний порт RAGFlow
- **11434** - Ollama API

**Сообщение при успешном завершении установки:**
```
✅ XRM Director успешно установлен!
📁 Установочная директория: /opt/xrm-director/docker/
📋 Логи: /var/log/xrmd_install.log

---

### 5️⃣ Перезапустить XRM Director

**Назначение:** Безопасный перезапуск всех сервисов XRM Director

**Процесс перезапуска:**

#### 5.1 Проверка текущего состояния
- Анализ запущенных контейнеров
- Проверка состояния контейнера Ollama
- Диагностика проблем при необходимости

#### 5.2 Перезапуск сервисов
- Перезапуск всех контейнеров
- Перезапуск контейнера Ollama
- Проверка статуса после перезапуска
- Health check всех контейнеров

---

### 6️⃣ Удалить XRM Director

**Назначение:** Полное удаление XRM Director с возможностью сохранения данных

**⚠️ ВНИМАНИЕ! Это действие необратимо!**

#### 6.1 Процесс удаления
- Остановка всех контейнеров, в т.ч. Ollama
- Удаление контейнеров
- Удаление Docker томов (пользовательские данные)
- Удаление Docker образов:
  - `infiniflow/ragflow:*` (все версии RAGFlow)
  - `ollama/ollama` (Ollama)
- Опциональное удаление директорий:
  - `/opt/xrm-director/` (конфигурация)
  - `/opt/xrm-director/backups/` (резервные копии)

---

### 7️⃣ Резервное копирование / Восстановление

**Назначение:** Управление резервными копиями данных XRM Director

### Подменю резервного копирования:

```

     🛠️  Резервное копирование / Восстановление RagFlow 🛠️
======================================================

1. Создать резервную копию всех томов
2. Просмотреть доступные резервные копии  
3. Восстановить из резервной копии
4. Управление резервными копиями
0. Вернуться в главное меню
```

#### 7.1 Создать резервную копию всех томов

**Что сохраняется:**
- **docker_mysql_data**
- **docker_minio_data**
- **docker_esdata01**
- **docker_redis_data**
- **docker_infinity_data**

**Процесс:**
- Остановка контейнеров
- Создание архивов для каждого тома
- Сохранение в `/opt/xrm-director/backups/user/ragflow_YYYY-MM-DD_HH-MM-SS/`
- Создание общего архива `ragflow_full_YYYY-MM-DD_HH-MM-SS.tar.gz`
- Запуск контейнеров

#### 7.2 Просмотреть доступные резервные копии

**Отображается информация:**
- **Дата и время** создания
- **Размер файла** резервной копии
- **Тип бэкапа** (пользовательский/системный)

**Типы бэкапов:**
- **Пользовательские** - созданные вручную в `/opt/xrm-director/backups/user/`
- **Системный (initial)** - предустановленный бэкап в `/opt/xrm-director/backups/initial/`

#### 7.3 Восстановить из резервной копии

**⚠️ ВНИМАНИЕ:** Восстановление полностью заменит текущие данные!

**Доступные источники:**
1. **Пользовательские бэкапы** - ваши созданные копии
2. **Системный бэкап (initial)** - базовая конфигурация

**Процесс восстановления:**
- Остановка всех контейнеров
- Очистка текущих томов
- Извлечение данных из выбранного архива
- Восстановление каждого тома
- Запуск контейнеров
- Проверка целостности

#### 7.4 Управление резервными копиями

**Доступные действия:**
1. **Удалить выбранную резервную копию**
2. **Оставить только последние N копий**
3. **Удалить все пользовательские бэкапы**
4. **Удалить системный бэкап**

---

### 8️⃣ Выйти

**Назначение:** Корректное завершение работы скрипта

---

## Основные компоненты системы

### Docker образы:
- **RAGFlow** - основная система (`infiniflow/ragflow:v0.19.1` или `infiniflow/ragflow:v0.19.1-slim`)
- **Ollama** - сервер языковых моделей (`ollama/ollama`)

### Модели Ollama:
- **llama3.1:8b** - основная языковая модель для обработки запросов
- **snowflake-arctic-embed:335m** - модель для создания векторных представлений

---

## Журналирование и мониторинг

### Файлы логов:
- **Основной лог:** `/var/log/xrmd_install.log`
- **Docker логи:** `journalctl -u docker.service`
- **Контейнер логи:** `docker compose logs -f`

### Мониторинг системы:
```bash
# Проверка статуса контейнеров
docker ps -a

# Мониторинг ресурсов
docker stats

# Проверка логов установки
tail -f /var/log/xrmd_install.log

# Логи RAGFlow
docker logs -f ragflow-server

# Логи Ollama
docker logs -f ollama
```

---

##  Устранение проблем

### Частые проблемы:

#### 1. Контейнер не запускается
```bash
# Проверить логи
docker logs container-name

# Проверить ресурсы
free -h && df -h

# Перезапустить контейнер
docker restart container-name
```

#### 2. Порты заняты
```bash
# Проверить занятые порты
ss -tulpn | grep :80
ss -tulpn | grep :11434

# Остановить конфликтующие сервисы
sudo systemctl stop httpd nginx
```

#### 3. Недостаточно места
```bash
# Очистить неиспользуемые образы
docker system prune -a

# Очистить логи
sudo journalctl --vacuum-time=7d
```

#### 4. Проблемы с vm.max_map_count
```bash
# Проверить текущее значение
cat /proc/sys/vm/max_map_count

# Установить временно
sudo sysctl -w vm.max_map_count=262144

# Установить постоянно
echo 'vm.max_map_count=262144' | sudo tee -a /etc/sysctl.conf
```

---

## Системные зависимости

### Автоматически устанавливаемые пакеты:
```bash
# Основные компоненты Docker
docker-ce docker-ce-cli docker-compose

# Системные утилиты (если отсутствуют)
curl wget tar gzip
```

---

*Инструкция для XRM Director v1.0 | Обновлено: 24.07.2025*
