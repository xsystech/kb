# Руководство Администратора по работе со скриптом xrmd_install_v_1_1.sh - XRM Director v1.1 на Red OS 8.0


- [Общая информация](#-общая-информация)
- [Системные требования](#-системные-требования)
- [Быстрый старт](#-быстрый-старт)
  - [CLI Режим (Командная строка)](#-cli-режим-командная-строка)
  - [Интерактивный режим (Меню)](#️-интерактивный-режим-меню)
- [Подробное описание меню](#-подробное-описание-меню)
  - [1️⃣ Системные требования](#1️-системные-требования)
  - [2️⃣ Информация о Docker](#2️-информация-об-установленных-docker--docker-compose)
  - [3️⃣ Установить Docker](#3️-установить-docker--docker-compose-redos)
  - [4️⃣ Установить XRM Director](#4️-установить-xrm-director)
  - [5️⃣ Перезапустить XRM Director](#5️-перезапустить-xrm-director)
  - [6️⃣ Удалить XRM Director](#6️-удалить-xrm-director)
  - [7️⃣ Резервное копирование](#7️-резервное-копирование--восстановление)
  - [8️⃣ Выйти](#8️-выйти)
- [Компоненты системы](#-компоненты-системы)
- [Журналирование и мониторинг](#-журналирование-и-мониторинг)
- [Устранение проблем](#-устранение-проблем)

---

## Общая информация<a id="-общая-информация"></a>

**XRM Director** - это система обнаружения событий, связанных со сбоями и аномалиями в журналах работы ПО.
**Версия скрипта усановки:** 1.0  
**Тип установки:** Docker-контейнеры  

### Аппаратные системные требования:<a id="-системные-требования"></a>
- **Архитектура:** x86_64
- **Процессор:** минимум 4 ядра (Рекомендовано не менее 8 физических процессорных ядер)
- **Оперативная память:** минимум 16 ГБ ОЗУ (не менее 64 ГБ ОЗУ)
- **Свободное место на диске:** минимум 50 GB (Рекомендовано не менее 250 ГБ дискового пространства)
- **GPU адаптер** Наличие в системе дискретного GPU адаптера: опционально

### Требования к ПО:
- **ОС:** Red OS 8.0 и выше
- **Права:** root/sudo доступ
- **Системный параметр ОС:** vm.max_map_count ≥ 262144
- **Docker:** минимум версия 24.0.0
- **Docker Compose:** минимум версия v2.26.1
- **Python**: версия > 3.10 - < 3.13, рекомендуемая 3.11

### Дополнительные требования для GPU версии:
- **GPU:** NVIDIA с поддержкой CUDA
- **NVIDIA Driver:** версия 470+ 
- **NVIDIA Container Toolkit:** установлен

---

## Быстрый старт<a id="-быстрый-старт"></a>

### Подготовка системы
```bash
# Загрузка установочного скрипта
wget -O xrmd_install_v_1_1.sh https://files.x-rm.ru/xrm_director/xrmd_install_v_1_1.sh
```
```bash
# Установка прав на выполнение скрипта
chmod +x xrmd_install_v_1_1.sh
```

### CLI Режим (Командная строка)<a id="-cli-режим-командная-строка"></a>

#### Команды справки (без sudo):
```bash
# Показать справку
./xrmd_install_v_1_1.sh --help
```
```bash
# Показать версию скрипта
./xrmd_install_v_1_1.sh --version
```

#### Автоматическая установка (требует sudo):
```bash
# Облегченная версия с CPU (рекомендуется для большинства случаев)
sudo ./xrmd_install_v_1_1.sh install slim cpu
```
```bash
# Полная версия с CPU (больше возможностей, больше ресурсов)
sudo ./xrmd_install_v_1_1.sh install full cpu
```
```bash
# Облегченная версия с GPU (требуется NVIDIA GPU)
sudo ./xrmd_install_v_1_1.sh install slim gpu
```
```bash
# Полная версия с GPU (максимальная производительность)
sudo ./xrmd_install_v_1_1.sh install full gpu
```

#### Синтаксис CLI команд:
```
sudo ./xrmd_install_v_1_1.sh install <VERSION> <PROCESSOR>

VERSION:
  slim    - Облегченная версия (~2.62 GB, без встроенных моделей)
  full    - Полная версия (~7.12 GB, со встроенными моделями)

PROCESSOR:
  cpu     - Использовать CPU для обработки (универсальный)
  gpu     - Использовать GPU для обработки (требует NVIDIA GPU)
```

### Интерактивный режим (Меню)<a id="️-интерактивный-режим-меню"></a>

#### Классический режим с пошаговым меню для интерактивной установки:

```bash
# Запустите скрипт с правами администратора
sudo ./xrmd_install_v_1_1.sh
```

## Подробное описание меню<a id="-подробное-описание-меню"></a>

#### Главное меню (Интерактивный режим)

После запуска скрипта `sudo ./xrmd_install_v_1_1.sh` вы увидите главное меню:

```
==========================================
          XRM Director версия 1.0         
==========================================

Меню:

1. Системные требования
2. Информация об установленных Docker / Docker Compose  
3. Установить Docker / Docker Compose (RedOS)
4. Установить XRM Director
5. Перезапустить XRM Director
6. Удалить XRM Director
7. Резервное копирование / Восстановление
8. Выйти
```

### Детальное описание пунктов меню:

- [1️⃣ Системные требования](#1️-системные-требования)
- [2️⃣ Информация о Docker](#2️-информация-об-установленных-docker--docker-compose)
- [3️⃣ Установить Docker](#3️-установить-docker--docker-compose-redos)
- [4️⃣ Установить XRM Director](#4️-установить-xrm-director)
- [5️⃣ Перезапустить XRM Director](#5️-перезапустить-xrm-director)
- [6️⃣ Удалить XRM Director](#6️-удалить-xrm-director)
- [7️⃣ Резервное копирование](#7️-резервное-копирование--восстановление)
- [8️⃣ Выйти](#8️-выйти)

---<a id="5️-перезапустить-xrm-director"></a>

### 1️⃣ Системные требования

**Назначение:** Проверка соответствия системы минимальным требованиям

**Что проверяется:**
- ✅ **Количество ядер процессора**
- ✅ **Объем оперативной памяти**
- ✅ **Свободное место на диске**
- ✅ **Версия Docker**
- ✅ **Версия Docker Compose**
- ✅ **Версия Python**
  
---

### 2️⃣ Информация об установленных Docker / Docker Compose<a id="2️-информация-об-установленных-docker--docker-compose"></a>

**Назначение:** Проверка установленных версий Docker и Docker Compose

**Что отображается:**
- **Версия Docker**
- **Версия Docker Compose**
- **Количество образов и контейнеров** и их статус
- **Информация о системе Docker** (версия сервера, ОС)

---

### 3️⃣ Установить Docker / Docker Compose (RedOS)<a id="3️-установить-docker--docker-compose-redos"></a>

**Назначение:** Автоматическая установка Docker и Docker Compose на Red OS
Если в вашей ОС установлен Docker, скрипт проинформирует об этом

**Процесс установки включает:**

#### 3.1 Установка Docker и Docker Compose
- Установка пакетов `docker-ce`, `docker-ce-cli`, `docker-compose`
- Запуск и активация службы Docker
- Добавление пользователя в группу `docker`

#### 3.2 Проверка установки
- ✅ Проверка статуса службы Docker
- ✅ Вывод информации о Docker
- ✅ Проверка работоспособности

**Что делать после установки:**

Перезагрузите систему или перелогиньтесь для применения изменений группы, или выйдите и войдите снова

```bash
sudo reboot
```

---

### 4️⃣ Установить XRM Director<a id="4️-установить-xrm-director"></a>

**Назначение:** Полная установка системы XRM Director
Интерактивный режим (Пошаговый) через меню.

При установке выберите редакцию 
- **Slim** - Облегченная версия (~2.62 GB, без встроенных LLM моделей)
- **Full** - Полная версия (~7.12 GB, со встроенными LLM моделями)
```
====== Установка XRM Director ======
✅ Docker установлен и запущен.
Выбор редакции RAGFlow v0.19.1:
0. Вернуться в главное меню
1. Slim - облегченная версия (~2.62 GB, без встроенных моделей)
2. Full - полная версия (~7.12 GB, со встроенными моделями)

Введите номер редакции (0-2): 
```

Далее выберите процессор для обработки CPU или GPU
```
Выбор процессора для обработки:
0. Вернуться в главное меню
1. CPU - универсальный вариант (работает на любой системе)
2. GPU - ускоренная обработка (требует NVIDIA GPU)

Введите номер процессора (0-2): 
```

Сообщение при успешном завершении установки:
```
✅ XRM Director успешно установлен!
📁 Установочная директория: /opt/xrm-director/docker/
📋 Логи: /var/log/xrmd_install.log
```
Установка завершена.


**Этапы установки (общие для обоих режимов):**

#### Последовательность действий скрипта при установке
- ✅ Проверка прав root
- ✅ Проверка системных требований  
- ✅ Проверка установки Docker
- ✅ Проверка существующих установок
- ✅ Скачивание архива с файлами XRM Director...
- ✅ Установка python3-pip, ragflow-sdk 
- ✅ Загрузка initial backup в директорию /opt/xrm-director/backups/initial
- ✅ Загрузка xrmd_agent_manager.py в директорию /opt/xrm-director/utils/
- ✅ Настройка vm.max_map_count...
- ✅ Настройка переменных окружения в `.env`
- ✅ Развертывание контейнеров XRM Director в системе
- ✅ Проверка запуска и состояние контейнеров
- ✅ Развертывание llm-server
- ✅ Установка моделей в llm-server
- ✅ Установка xinference
- ✅ Установка модели реранкинга в xinference
- ✅ Загрузка и парсинг файла базы знаний

#### Схема структуры директорий
```
/opt/xrm-director/
├── docker/                    # Docker конфигурация
│   ├── docker-compose.yml     # Основной compose файл (CPU)
│   ├── docker-compose-gpu.yml # GPU версия
│   └── .env                   # Переменные окружения
├── backups/                   # Резервные копии
│   ├── initial/               # Системные бэкапы
│   └── user/                  # Пользовательские бэкапы
└── utils
    └── xrmd_agent_manager.py  # Менеджер по работе с агентами
```
#### Запуск LLM контейнеров

- Установка и запуск llm-server с моделями:
  - **llama3.1:8b** (основная языковая модель)
  - **snowflake-arctic-embed:335m** (модель для embeddings)
- Проверка готовности сервисов
- Автоматическое восстановление начального бэкапа (если включено)

#### Используемые порты, для информации
- **80** - HTTP доступ к веб-интерфейсу RAGFlow
- **443** - HTTPS доступ (если настроен)
- **9380** - Внутренний порт RAGFlow
- **11434** - llm-server API

**Сообщение при успешном завершении установки:**
```
✅ XRM Director успешно установлен!
📁 Установочная директория: /opt/xrm-director/docker/
📋 Логи: /var/log/xrmd_install.log
```
---

### 5️⃣ Перезапустить XRM Director<a id="5️-перезапустить-xrm-director"></a>

**Назначение:** Безопасный перезапуск всех сервисов XRM Director

**Процесс перезапуска:**

#### 5.1 Проверка текущего состояния
- Анализ запущенных контейнеров
- Проверка состояния контейнера llm-server
- Диагностика проблем при необходимости

#### 5.2 Перезапуск сервисов
- Перезапуск всех контейнеров
- Перезапуск контейнера llm-server
- Проверка статуса после перезапуска
- Health check всех контейнеров

---

### 6️⃣ Удалить XRM Director<a id="6️-удалить-xrm-director"></a>

**Назначение:** Полное удаление XRM Director с возможностью сохранения данных

**⚠️ ВНИМАНИЕ! Это действие необратимо!**

#### 6.1 Процесс удаления
- Остановка всех контейнеров
- Удаление контейнеров
- Удаление Docker томов (пользовательские данные)
- Удаление Docker образов:
- Опциональное удаление директорий:
  - `/opt/xrm-director/` (конфигурация)
  - `/opt/xrm-director/backups/` (резервные копии)

---

### 7️⃣ Резервное копирование / Восстановление<a id="7️-резервное-копирование--восстановление"></a>

**Назначение:** Управление резервными копиями данных XRM Director

### Подменю резервного копирования:

```
     🛠️  Резервное копирование / Восстановление RagFlow 🛠️

1. Создать резервную копию всех томов
2. Просмотреть доступные резервные копии  
3. Восстановить из резервной копии
4. Управление резервными копиями
0. Вернуться в главное меню
```

#### 7.1 Создать резервную копию всех томов

**Что сохраняется:**
- **docker_mysql_data**
- **docker_minio_data**
- **docker_esdata01**
- **docker_redis_data**
- **docker_infinity_data**

**Процесс:**
- Остановка контейнеров
- Создание архивов для каждого тома
- Сохранение в `/opt/xrm-director/backups/user/ragflow_YYYY-MM-DD_HH-MM-SS/`
- Создание общего архива `ragflow_full_YYYY-MM-DD_HH-MM-SS.tar.gz`
- Запуск контейнеров

#### 7.2 Просмотреть доступные резервные копии

**Отображается информация:**
- **Дата и время** создания
- **Размер файла** резервной копии
- **Тип бэкапа** (пользовательский/системный)

**Типы бэкапов:**
- **Пользовательские** - созданные вручную в `/opt/xrm-director/backups/user/`
- **Системный (initial)** - предустановленный бэкап в `/opt/xrm-director/backups/initial/`

#### 7.3 Восстановить из резервной копии

**⚠️ ВНИМАНИЕ:** Восстановление полностью заменит текущие данные!

**Доступные источники:**
1. **Пользовательские бэкапы** - ваши созданные копии
2. **Системный бэкап (initial)** - базовая конфигурация

**Процесс восстановления:**
- Остановка всех контейнеров
- Очистка текущих томов
- Извлечение данных из выбранного архива
- Восстановление каждого тома
- Запуск контейнеров
- Проверка целостности

#### Восстановление системного бэкапа

Выбрать п. 3. Восстановить из резервной копии, далее выбрать источник восстановления: Системный бэкап (initial) - "S"
```
1. Создать резервную копию всех томов
2. Просмотреть доступные резервные копии
3. Восстановить из резервной копии
4. Управление резервными копиями
0. Вернуться в главное меню

Выберите действие: 3
🔄 Восстановление из бэкапа
📋 Доступные пользовательские бэкапы:
⚠️ Пользовательские полные архивы не найдены

📋 Системные бэкапы (initial):
[S] initial_backup.tar.gz (11M, создан: 2025-07-24 15:07:09)

Выберите источник восстановления:
1. Пользовательский бэкап (введите номер из списка)
S. Системный бэкап (initial)
q. Отмена
Ваш выбор: S
```
Далее подтветрить выбором (д/y/да/yes)
```...
Ваш выбор: s
⚠️ Внимание! Восстановление из системного бэкапа перезапишет текущие данные томов.
Вы уверены? (д/y/да/yes - да, н/n/нет/no - нет): 
```
Сообщение при успешном восстановлении
```
🎉 Успешно восстановлено томов из системного бэкапа: 4 из 4
```

#### 7.4 Управление резервными копиями

**Доступные действия:**
1. **Удалить выбранную резервную копию**
2. **Оставить только последние N копий**
3. **Удалить все пользовательские бэкапы**
4. **Удалить системный бэкап**

---

### 8️⃣ Выйти<a id="8️-выйти"></a>

**Назначение:** Корректное завершение работы скрипта

---

## Основные компоненты системы<a id="-компоненты-системы"></a>

### Docker образы:
- **RAGFlow** - основная система (`infiniflow/ragflow:v0.19.1` или `infiniflow/ragflow:v0.19.1-slim`)
- **llm-server** - сервер языковых моделей

### Модели llm-server:
- **saiga_gemma3_12b-Q4_K_S-GGUF** - основная языковая модель для обработки запросов
- **snowflake-arctic-embed:335m** - модель для создания векторных представлений
- **bge-reranker-base** - rerank модель

---

## Журналирование и мониторинг<a id="-журналирование-и-мониторинг"></a>

### Файлы логов:
- **Основной лог:** `/var/log/xrmd_install.log`
- **Docker логи:** `journalctl -u docker.service`
- **Контейнер логи:** `docker compose logs -f`

### Мониторинг системы:
```bash
# Проверка статуса контейнеров
docker ps -a

# Мониторинг ресурсов
docker stats

# Проверка логов установки
tail -f /var/log/xrmd_install.log

# Логи RAGFlow
docker logs -f ragflow-server


```

---

##  Устранение проблем<a id="-устранение-проблем"></a>

### Частые проблемы:

#### 1. Контейнер не запускается
```bash
# Проверить логи
docker logs container-name

# Проверить ресурсы
free -h && df -h

# Перезапустить контейнер
docker restart container-name
```

#### 2. Порты заняты
```bash
# Проверить занятые порты
ss -tulpn | grep :80
ss -tulpn | grep :11434

# Остановить конфликтующие сервисы
sudo systemctl stop httpd nginx
```

#### 3. Недостаточно места
```bash
# Очистить неиспользуемые образы
docker system prune -a

# Очистить логи
sudo journalctl --vacuum-time=7d
```

#### 4. Проблемы с vm.max_map_count
```bash
# Проверить текущее значение
cat /proc/sys/vm/max_map_count

# Установить временно
sudo sysctl -w vm.max_map_count=262144

# Установить постоянно
echo 'vm.max_map_count=262144' | sudo tee -a /etc/sysctl.conf
```

---

## Системные зависимости

### Автоматически устанавливаемые пакеты:
```bash
# Основные компоненты Docker
docker-ce docker-ce-cli docker-compose

# Системные утилиты (если отсутствуют)
curl wget tar gzip

# Другие
ragflow-sdk
```

---

*Инструкция для XRM Director v1.0 | Обновлено: 24.07.2025*
